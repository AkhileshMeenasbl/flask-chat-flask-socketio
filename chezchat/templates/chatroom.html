{% extends "base.html" %}

{% block content %}

    <div class="container-fluid app">        
        <!-- Sidebar start -->
        <div class="row app">
            <div id="appNavArea" class="col-sm-4 side forMedia">
                <div class="heading">
                    <em id="my_status"></em><br>
                    <em>Current User: {{ current_user.username }}</em>
                    <a href="#" data-toggle="modal" data-target="#myModal">New group</a>
                </div>

                <div class="nav-section" data-simplebar>
                    <h5><em>Friends</em></h5>
                    <div id="friendsPanel">
                        {% for friend, room in zipped_friends_list %}
                            <!-- onclick a function triggers ajax to get the needed -->
                            <div id="{{ room.room_id }}" class="user-list" onclick="getCurrentRoom(this); verify_status()">
                                <div class="name-section">
                                    {{ friend.name_surname }}
                                </div>
                                <!-- possible ID conflict as I use room id here too -->
                                <!-- button should always be last in this div -->
                                <!-- create a warning modal for this. this button should trigger the modal and the modal's button should execute onclick="removeUser(this) -->
                                <button class="btn btn-danger btn-sm" name="{{ friend.name_surname }}" value="{{ friend.username }}" onclick="removeUser(this)"><i class="fas fa-user-minus"></i></button>
                            </div>
                        {% endfor %}
                    </div>

                    <h5><em>My rooms</em></h5>
                    <div id="roomsPanel">
                    {% for room in rooms %}
                        {% if room.private_room == False %}
                            <div id="{{ room.room_id }}" class="user-list" onclick="getCurrentRoom(this)">
                                <div class="name-section">
                                    {{ room.name }}
                                </div>
                                <button class="btn btn-danger btn-sm" id="roomView" name="{{ room.name }}" value="{{ room.room_id }}" onclick="leaveRoom(this)"><span class="font-weight-bold">Exit</span></button>
                            </div>
                        {% endif %}
                    {% endfor %}
                    </div>

                    <h5><em>Available users</em></h5>
                    <div id="availableUsers">
                        {% for user in non_friend_users %}
                            {% if user != current_user %}
                                <div class="user-list">
                                    <div class="name-section">
                                        {{ user.name_surname }}
                                    </div>
                                    <button class="btn btn-success btn-sm" name="{{ user.name_surname }}" value="{{ user.username }}" onclick="addUser(this)"><i class="fas fa-user-plus"></i></button>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <h5><em>Available rooms</em></h5>
                    <div id="availableRooms">
                        {% for room in all_rooms %}
                            {% if room.private_room == False and room not in current_user.room_subscribed %}
                            <div class="user-list">
                                <div class="name-section">
                                    {{ room.name }}
                                </div>
                                <button class="btn btn-success btn-sm" name="{{ room.name }}" value="{{ room.room_id }}" onclick="joinRoom(this)"><span class="font-weight-bold">Join</span></button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                
                <div>
                    <a style="text-decoration: none;" href="{{ url_for('logout') }}"><button style="border-radius: 0;" type="button" class="btn btn-danger btn-block btn-sm">Logout</button></a>
                </div>
            </div>
        
            <!-- Sidebar end -->

            <!-- My status -->
            <div id="appChatArea" class="col-sm-8 chatArea forMedia">

                <!-- should show when a group/room is clicked and should get the info by ajax-->
                <div class="heading" data-toggle="modal" data-target="#myModal2">
                    <i class="fas fa-arrow-left" onclick="hideChatArea()"></i>
                    <div style="display: block;">
                        <div id="currentRoomName"></div>
                        <div id="user_status"></div>
                    </div>
                    <!-- I have this guys ID on button click assign this the button value -->
                    <div id="get_user_status" hidden></div>
                </div>

                <!-- Navbar end -->
                
                <div id="chatWindow" class="messageArea" data-simplebar>

                    <div id="pre-user-select">
                        <div id="pre-user-msg" style="font-size: 16px;" class="text-muted">
                            Please select a chat to start messaging
                        </div>
                        <div id="pre-user-spinner" class="spinner-border text-muted" role="status" hidden>
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- todo on click of the div section assign id here to be room number and only display -->
                    <!-- todo the messages when the room matches the id here -->
                    <!-- todo for notification purposes, use the room id as key and increment it's value -->
                    <!-- todo to match the number of times a message directed to it was received by the server-->
                    <!-- todo when a client is offline, hold on to this value for them and emit when they are online -->
                    <div id="messages"></div>
                </div>

                <div id="msgInput">
                    <div style="display: flex; margin: 0; width: 100%; justify-content: center;">

                        <div style="width: 15%;" class="zero flex-absolute-center">
                            <i class="far fa-laugh fa-3x"></i>
                        </div>

                        <div style="width: 70%;" class="zero flex-absolute-center">
                            <input id="myMessage" type="text" name="message" autocomplete="off" placeholder="Type a message">
                        </div>

                        <div style="width: 15%;" class="zero flex-absolute-center">
                            <button id="sendbutton" class="btn btn-primary" type="button" name="submit"><i class="fas fa-paper-plane fa-2x"></i></button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <div class="modal fade" id="myModal">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 400px; margin: 1.75rem auto;">
                <div class="modal-content" style="margin: .5rem;">

                    <div class="modal-header">
                        <h4 class="modal-title" style="font-size: 14px; font-weight: 600;">New group</h4>
                        <button type="button" class="close close-button" data-dismiss="modal" style="outline: none; font-weight: 500; font-size: 17px;">close</button>
                    </div>

                    <div class="modal-body" style="max-height: 430px; overflow: auto;">
                        {{ form.name }}
                    </div>

                    <div class="modal-footer">
                        {{ form.submit() }}
                    </div>

                </div>
            </div>
        </div>
    </form>

    <div class="modal fade" id="myModal2">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 400px; margin: 1.75rem auto;">
            <div class="modal-content" style="margin: .5rem;">

                <div class="modal-header">
                    <h4 class="modal-title" style="font-size: 14px; font-weight: 600;">Group info</h4>
                    <button type="button" class="close close-button" data-dismiss="modal" style="outline: none; font-weight: 500; font-size: 17px;">close</button>
                </div>

                <div id="roomInfoModal" class="modal-body" style="max-height: 430px; overflow: auto;">

                </div>

            </div>
        </div>
    </div>

<!-- Modal to assert prevent multiple sessions -->
<div class="modal fade" id="preventMultModal" style="overflow: hidden;" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body d-flex">
                <span>You have been disconnected because you have another tab open</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger btn-block" onclick="window.location.href=window.location.href">Click to reload</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

    <!-- Get current_user.username -->
    <script type="text/javascript">
        const username = '{{ current_user.username }}';
    </script>

    <!-- SocketIO JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>

    <!-- Custom SocketIO JS -->
    <script src="{{ url_for('static', filename='scripts/socketio.js') }}"></script>

    <!-- Helper scripts for functionality -->
    <script src="{{ url_for('static', filename='scripts/extras.js') }}"></script>
    
{% endblock %}

